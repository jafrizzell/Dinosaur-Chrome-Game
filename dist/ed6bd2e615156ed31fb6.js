const tmi=require("tmi.js"),GIF=require("../src/gifLoader.js"),is_pleb=t=>!!t&&(void 0!==t.subscriber||void 0!==t["sub-gifter"]||void 0!==t.moderator||void 0!==t.vip||Number(t.bits)>500);class Chat{constructor(t={}){this.config=Object.assign({duplicateEmoteLimit:0,duplicateEmoteLimit_pleb:null,maximumEmoteLimit:5,maximumEmoteLimit_pleb:null,gifAPI:"https://gif-emotes.opl.io"},t),this.config.channels||(this.config.channels=["moonmoon"]),null===this.config.duplicateEmoteLimit_pleb&&(this.config.duplicateEmoteLimit_pleb=this.config.duplicateEmoteLimit),this.emotes={},this.bttvEmotes={},this.emoteGifs={},this.listeners={},this.client=new tmi.Client({options:{debug:!1},connection:{reconnect:!0,secure:!0},channels:this.config.channels}),this.fetchBTTVEmotes(),this.client.addListener("message",this.handleChat.bind(this)),this.client.connect()}on(t="emotes",i){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(i)}dispatch(t,i){if(this.listeners[t])for(let e=0;e<this.listeners[t].length;e++)this.listeners[t][e](i)}fetchBTTVEmotes(){for(let t=0;t<this.config.channels.length;t++){const i=this.config.channels[t].replace("#","");fetch(`${this.config.gifAPI}/channel/username/${i}.js`).then((t=>t.json())).then((t=>{if(!t.error&&404!==t)for(let i=0;i<t.length;i++){const e=t[i];this.bttvEmotes[e.code]=e.id}}))}}handleChat(t,i,e,s){var o;this.getEmoteArrayFromMessage(e,i.emotes,!!(o=i.badges)&&(void 0!==o.subscriber||void 0!==o["sub-gifter"]||void 0!==o.moderator||void 0!==o.vip||Number(o.bits)>500))}getEmoteArrayFromMessage(t,i,e){const s=new Array,o=t.split(" ");let n=0;const h=e?this.config.duplicateEmoteLimit:this.config.duplicateEmoteLimit_pleb,m={},c=(t,i)=>{m[t.id]||(m[t.id]=0),m[t.id]<=h&&(i.push(t),m[t.id]++)};for(let t=0;t<o.length;t++){const e=o[t];if(null!==i)for(let t in i)for(let o=0;o<i[t].length;o++){const h=i[t][o].split("-");if(parseInt(h[0])===n){c({gif:this.drawEmote("https://static-cdn.jtvnw.net/emoticons/v2/"+t+"/default/dark/3.0"),id:t,name:e},s),m[e]||(m[e]=0);break}}const h=this.checkIfBTTVEmote(e);!1!==h&&c({gif:h,id:e,name:e},s),n+=e.length+1}s.length>0&&this.dispatch("emotes",this.config.maximumEmoteLimit?s.splice(0,this.config.maximumEmoteLimit):s)}checkIfBTTVEmote(t){return!(!this.bttvEmotes[t]||this.emotes[t])&&this.drawEmote(this.bttvEmotes[t])}drawEmote(t){if(!this.emoteGifs[t]){const i=new GIF(t,{gifAPI:this.config.gifAPI});this.emoteGifs[t]=i}return this.emoteGifs[t]}}export default Chat;